# Настройка OpenRouter API для доступа к LLM-моделям

## Обзор

OpenRouter — это сервис, предоставляющий унифицированный API для доступа к различным языковым моделям, включая GPT-4o, Claude-3, Llama, Gemini и другие. Использование OpenRouter позволяет легко переключаться между различными моделями без необходимости изменения кода или получения отдельных API-ключей для каждой модели.

## Преимущества использования OpenRouter

1. **Единый интерфейс** для доступа к различным моделям
2. **Отказоустойчивость** благодаря возможности переключения между моделями
3. **Оптимизация затрат** через автоматический выбор более доступных моделей
4. **Простая интеграция** с n8n через ноды LLM-интеграции

## Шаги по получению API-ключа OpenRouter

### 1. Регистрация на OpenRouter

1. Перейдите на сайт [OpenRouter](https://openrouter.ai/)
2. Нажмите кнопку "Sign Up" в правом верхнем углу
3. Зарегистрируйтесь с помощью:
   - GitHub
   - Google
   - Discord
   - Email + пароль
4. Подтвердите свою учетную запись через email (если выбран метод регистрации через email)

### 2. Создание API-ключа

1. После входа в систему перейдите в раздел "API Keys" в боковом меню
2. Нажмите кнопку "Create API Key"
3. Дайте ключу понятное название (например, "N8N Bot Integration")
4. Выберите следующие разрешения:
   - `completions:create` - для генерации текста
   - `completions:usage:read` - для просмотра статистики использования
5. Нажмите "Create"
6. **Важно**: Скопируйте сгенерированный ключ и сохраните его в безопасном месте. Ключ будет показан только один раз!

### 3. Управление моделями и квотами

1. Перейдите в раздел "Models" в боковом меню
2. Здесь вы можете просмотреть доступные модели и их стоимость
3. Установите квоты и ограничения для каждой модели в разделе "Settings"
4. Рекомендуемые модели для использования:
   - `openai/gpt-4o` - основная модель для центрального агента
   - `anthropic/claude-3-opus` - для сложных задач и генерации контента
   - `google/gemini-pro` - для мультимодальных задач
   - `meta-llama/llama-3` - для быстрых и простых задач

### 4. Пополнение баланса

1. Перейдите в раздел "Billing" в боковом меню
2. Нажмите кнопку "Add credits"
3. Выберите сумму пополнения и способ оплаты
4. Завершите процесс оплаты
5. Проверьте, что средства были зачислены на ваш аккаунт

## Интеграция с n8n

### 1. Добавление учетных данных в n8n

1. В интерфейсе n8n перейдите в "Settings" > "Credentials"
2. Нажмите кнопку "Add Credential"
3. В поисковой строке введите "OpenRouter"
4. Выберите тип учетных данных "OpenRouter API"
5. Заполните следующие поля:
   - **Name**: Понятное название (например, "OpenRouter LLM Access")
   - **API Key**: Вставьте ваш API-ключ OpenRouter
6. Нажмите "Save" для сохранения учетных данных

### 2. Использование OpenRouter в рабочих потоках

#### Для агентов в формате n8n LangChain:

```json
{
  "parameters": {
    "model": "openai/gpt-4o",
    "options": {}
  },
  "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
  "typeVersion": 1,
  "position": [500, 260],
  "id": "22b4f59a-c3f0-48fe-a51f-26e1656f87a2",
  "name": "OpenRouter Chat Model",
  "credentials": {
    "openRouterApi": {
      "id": "YOUR_CREDENTIALS_ID",
      "name": "OpenRouter account"
    }
  }
}
```

#### Для использования через HTTP-запрос:

```json
{
  "parameters": {
    "method": "POST",
    "url": "https://openrouter.ai/api/v1/chat/completions",
    "authentication": "headerAuth",
    "headerParameters": {
      "parameters": [
        {
          "name": "Authorization",
          "value": "Bearer YOUR_API_KEY"
        },
        {
          "name": "HTTP-Referer",
          "value": "https://n8n.example.com"
        }
      ]
    },
    "contentType": "json",
    "sendBody": true,
    "bodyParameters": {
      "parameters": [
        {
          "name": "model",
          "value": "openai/gpt-4o"
        },
        {
          "name": "messages",
          "value": "={{ $json.messages }}"
        }
      ]
    },
    "options": {}
  },
  "type": "n8n-nodes-base.httpRequest",
  "typeVersion": 4.2,
  "position": [600, 380]
}
```

## Рекомендации по использованию различных моделей

### gpt-4o (OpenAI)

**Рекомендуемое применение**:
- Центральный оркестратор для управления агентами
- Сложные задачи планирования и приоритизации
- Требующие высокой точности и многоступенчатого рассуждения задачи

**Стоимость**: Около $5-10 за 1 миллион токенов

### claude-3-opus (Anthropic)

**Рекомендуемое применение**:
- Создание сложного текстового контента
- Глубокий анализ информации
- Задачи, требующие следования сложным инструкциям

**Стоимость**: Около $15-20 за 1 миллион токенов

### gemini-pro (Google)

**Рекомендуемое применение**:
- Мультимодальные задачи (работа с изображениями)
- Общие задачи средней сложности
- Анализ табличных данных

**Стоимость**: Около $3-5 за 1 миллион токенов

### llama-3 (Meta)

**Рекомендуемое применение**:
- Простые и быстрые задачи
- Классификация и категоризация
- Предварительная обработка запросов

**Стоимость**: Около $1-3 за 1 миллион токенов

## Оптимизация затрат

Для оптимизации затрат на использование LLM-моделей, рекомендуется:

1. **Использовать подходящую модель для каждой задачи**
   - Не используйте мощные модели для простых задач
   - Распределяйте задачи по моделям в зависимости от их сложности

2. **Ограничивать контекст**
   - Передавайте только необходимую информацию в запросах
   - Используйте эффективные промпты для минимизации токенов

3. **Реализовать кэширование**
   - Кэшируйте результаты для часто запрашиваемой информации
   - Избегайте повторных запросов для одинаковых входных данных

4. **Мониторить использование**
   - Регулярно проверяйте статистику использования в OpenRouter
   - Настраивайте алерты на превышение лимитов

## Устранение проблем

### Ошибка "Insufficient credits"

**Решение**: Пополните баланс на OpenRouter или настройте квоты для ограничения использования.

### Ошибка "Rate limit exceeded"

**Решение**: 
- Уменьшите частоту запросов
- Реализуйте механизм повторных попыток с экспоненциальной задержкой
- Рассмотрите возможность использования других моделей

### Ошибка "Model not available"

**Решение**:
- Проверьте доступность модели в OpenRouter
- Настройте автоматическое переключение на альтернативные модели
- Убедитесь, что у вас есть доступ к выбранной модели

## Дополнительные ресурсы

- [Официальная документация OpenRouter](https://openrouter.ai/docs)
- [Примеры использования с n8n](https://n8n.io/integrations/openrouter/)
- [Сравнение моделей LLM](https://openrouter.ai/models)