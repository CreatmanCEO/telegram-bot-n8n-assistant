# SearchAgent - Агент поиска информации

## Назначение

SearchAgent — это специализированный агент для поиска и анализа информации в интернете по запросу пользователя. Основная задача агента — формулировать эффективные поисковые запросы, анализировать найденную информацию, структурировать её и представлять пользователю в удобном виде.

## Ключевые функции

1. **Формирование оптимальных поисковых запросов** на основе запроса пользователя
2. **Анализ и обобщение** найденной информации
3. **Извлечение ключевых фактов и данных** из результатов поиска
4. **Проверка информации** через сравнение нескольких источников
5. **Структурирование информации** для представления пользователю
6. **Сохранение важной информации** в векторной памяти (RAG)

## Структура рабочего потока

Ниже представлена структура рабочего потока SearchAgent в n8n:

```
Workflow Trigger → LLM Agent → Tavily Search → Web Content Extraction → Result Formatting → Return Result
                        ↓                                                       ↑
                        ↓                                                       ↑
                   Memory System ──────────────────────────────────────────────┘
                   (RAG)
```

## Компоненты

### 1. Workflow Trigger Node

**Тип**: `n8n-nodes-base.executeWorkflowTrigger`

**Параметры**:
```json
{
  "parameters": {
    "workflowInputs": {
      "mappingMode": "defineBelow",
      "value": {
        "query": ""
      },
      "schema": [
        {
          "name": "query",
          "required": true,
          "type": "string",
          "description": "Запрос для поиска информации"
        }
      ]
    }
  }
}
```

**Назначение**: Принимает запрос от центрального оркестратора и запускает рабочий поток.

### 2. LLM Agent Node

**Тип**: `@n8n/n8n-nodes-langchain.agent`

**Параметры**:
```json
{
  "parameters": {
    "promptType": "define",
    "text": "={{ $json.query }}",
    "options": {
      "systemMessage": "# SearchAgent\n\nТы специализированный агент для поиска информации. Твоя задача - находить, анализировать и представлять актуальную информацию по запросу пользователя.\n\n## Доступные инструменты\n\n1. tavilySearch - поиск информации в интернете\n2. extractWebContent - извлечение содержимого веб-страниц\n3. saveToKnowledge - сохранение важной информации в базу знаний\n\n## Правила работы\n\n1. Анализируй запрос пользователя и определяй ключевые аспекты для поиска\n2. Формулируй точные и конкретные поисковые запросы\n3. При необходимости разбивай сложные запросы на несколько простых\n4. Анализируй результаты поиска и выделяй самую важную информацию\n5. Обращай внимание на достоверность источников\n6. Сравнивай информацию из разных источников\n7. Структурируй информацию для представления пользователю\n8. Сохраняй важную и полезную информацию в базе знаний\n\n## Процесс поиска\n\n1. Определи ключевые слова и аспекты запроса\n2. Выполни поиск с помощью tavilySearch\n3. Анализируй результаты и при необходимости уточняй запрос\n4. Для важных источников используй extractWebContent для получения полного содержимого\n5. Организуй и структурируй найденную информацию\n6. Предоставь итоговый результат с указанием источников\n\n## Формат ответа\n\n1. Краткое резюме (1-2 предложения)\n2. Основные факты и информация (структурированно)\n3. Дополнительные детали (при необходимости)\n4. Источники информации\n\nТекущая дата: {{ $now }}"
    }
  }
}
```

**Назначение**: Основной LLM-агент, который анализирует запрос пользователя, формирует поисковые запросы и координирует процесс поиска.

### 3. Tavily Search Tool

**Тип**: `@n8n/n8n-nodes-langchain.toolHttpRequest`

**Параметры**:
```json
{
  "parameters": {
    "toolDescription": "Искать информацию в интернете. Используй для поиска актуальных данных, новостей и фактов. Указывай максимально конкретный поисковый запрос.",
    "method": "POST",
    "url": "https://api.tavily.com/search",
    "authentication": "predefinedCredentialType",
    "nodeCredentialType": "httpHeaderAuth",
    "sendBody": true,
    "specifyBody": "json",
    "jsonBody": "{\n    \"api_key\": \"YOUR_API_KEY\",\n    \"query\": \"{query}\",\n    \"search_depth\": \"{depth}\",\n    \"include_answer\": true,\n    \"include_raw_content\": true,\n    \"max_results\": {max_results}\n}",
    "placeholderDefinitions": {
      "values": [
        {
          "name": "query",
          "description": "Поисковый запрос",
          "type": "string"
        },
        {
          "name": "depth",
          "description": "Глубина поиска (basic или advanced)",
          "type": "string",
          "default": "basic"
        },
        {
          "name": "max_results",
          "description": "Максимальное количество результатов",
          "type": "number",
          "default": 5
        }
      ]
    }
  }
}
```

**Назначение**: Выполняет поиск информации в интернете с использованием Tavily API.

### 4. Web Content Extraction Tool

**Тип**: `@n8n/n8n-nodes-langchain.toolHttpRequest`

**Параметры**:
```json
{
  "parameters": {
    "toolDescription": "Извлечь содержимое веб-страницы. Используй для получения полного текста статьи или документа по URL.",
    "method": "GET",
    "url": "{url}",
    "placeholderDefinitions": {
      "values": [
        {
          "name": "url",
          "description": "URL веб-страницы для извлечения содержимого",
          "type": "string"
        }
      ]
    }
  }
}
```

**Назначение**: Извлекает полное содержимое веб-страницы по указанному URL.

### 5. Save To Knowledge Tool

**Тип**: `@n8n/n8n-nodes-langchain.toolWorkflow`

**Параметры**:
```json
{
  "parameters": {
    "name": "saveToKnowledge",
    "description": "Сохранить важную информацию в базу знаний для последующего использования. Используй для хранения полезных фактов, данных и информации.",
    "workflowId": {
      "value": "YOUR_WORKFLOW_ID",
      "mode": "list",
      "cachedResultName": "Save to Knowledge Base"
    },
    "workflowInputs": {
      "mappingMode": "defineBelow",
      "value": {
        "text": "={{ $fromAI(\"text\", \"Текст для сохранения\") }}",
        "source": "={{ $fromAI(\"source\", \"Источник информации\") }}",
        "category": "={{ $fromAI(\"category\", \"Категория информации\") }}",
        "userId": "={{ $fromAI(\"userId\", \"ID пользователя\") }}"
      }
    }
  }
}
```

**Назначение**: Сохраняет важную информацию в векторную базу данных для последующего использования.

### 6. Language Model Integration

**Тип**: `@n8n/n8n-nodes-langchain.lmChatOpenRouter`

**Параметры**:
```json
{
  "parameters": {
    "model": "openai/gpt-4o",
    "options": {}
  }
}
```

**Назначение**: Предоставляет доступ к языковой модели gpt-4o через OpenRouter для работы SearchAgent.

### 7. Memory Integration

**Тип**: `@n8n/n8n-nodes-langchain.vectorStorePinecone`

**Параметры**:
```json
{
  "parameters": {
    "mode": "retrieve-as-tool",
    "toolName": "queryKnowledge",
    "toolDescription": "Поиск информации в базе знаний. Используй для получения ранее сохраненной информации.",
    "pineconeIndex": "knowledge_base",
    "options": {}
  }
}
```

**Назначение**: Интегрирует векторную базу данных Pinecone для хранения и извлечения информации.

## Системный промпт для SearchAgent (подробная версия)

```
# SearchAgent

Ты специализированный агент для поиска информации. Твоя задача - находить, анализировать и представлять актуальную информацию по запросу пользователя.

## Процесс работы

1. **Анализ запроса**
   - Определи основную тему и цель запроса
   - Выдели ключевые слова и понятия
   - Определи тип ожидаемой информации (факты, мнения, статистика, новости и т.д.)

2. **Формирование поисковых запросов**
   - Создавай четкие и конкретные запросы
   - Используй операторы поиска при необходимости
   - Для сложных запросов сформулируй несколько поисковых запросов по разным аспектам

3. **Анализ результатов**
   - Оценивай достоверность источников
   - Проверяй актуальность информации
   - Сравнивай данные из разных источников
   - Выделяй ключевые факты и данные

4. **Структурирование информации**
   - Организуй информацию в логическую структуру
   - Группируй связанные факты и данные
   - Выделяй основные выводы и итоги

5. **Сохранение важной информации**
   - Определяй информацию, которая может быть полезна в будущем
   - Категоризируй информацию для удобного поиска
   - Сохраняй информацию с указанием источника и контекста

## Доступные инструменты

1. **tavilySearch** - поиск информации в интернете
   - Параметры:
     - query: поисковый запрос (обязательный)
     - depth: глубина поиска ("basic" или "advanced")
     - max_results: максимальное количество результатов

2. **extractWebContent** - извлечение содержимого веб-страниц
   - Параметры:
     - url: URL веб-страницы для извлечения

3. **saveToKnowledge** - сохранение важной информации в базу знаний
   - Параметры:
     - text: текст для сохранения
     - source: источник информации
     - category: категория информации
     - userId: ID пользователя

4. **queryKnowledge** - поиск информации в базе знаний
   - Параметры:
     - query: поисковый запрос
     - filter: фильтр для поиска (опционально)

## Стратегии поиска

### Для новостей и актуальных событий
- Включай даты в поисковый запрос
- Используй названия надежных новостных источников
- Проверяй несколько источников для подтверждения информации

### Для научных или технических тем
- Используй точную терминологию
- Ищи академические или специализированные источники
- Проверяй актуальность информации (наука быстро развивается)

### Для общих знаний
- Начинай с широкого запроса, затем уточняй
- Ищи энциклопедические или образовательные ресурсы
- Обращай внимание на консенсус между источниками

## Формат ответа

1. **Краткое резюме** (1-2 предложения с основной информацией)
2. **Детальный ответ**:
   - Основные факты и данные
   - Контекст и дополнительная информация
   - Различные точки зрения (если применимо)
3. **Источники**:
   - Список использованных источников с указанием достоверности
   - URL или названия источников

Текущая дата: {{ $now }}
```

## Интеграция с основным рабочим потоком

Для подключения SearchAgent к центральному оркестратору используется узел n8n типа `@n8n/n8n-nodes-langchain.toolWorkflow`. Ниже представлен пример интеграции:

```json
{
  "parameters": {
    "name": "searchAgent",
    "description": "Используйте этот инструмент для поиска и анализа информации в интернете. Он помогает находить актуальные данные, новости, статистику и факты по запросу.",
    "workflowId": {
      "value": "YOUR_WORKFLOW_ID",
      "mode": "list",
      "cachedResultName": "SearchAgent"
    },
    "workflowInputs": {
      "mappingMode": "defineBelow",
      "value": {
        "query": "={{ $fromAI(\"query\", \"Запрос для поиска информации\") }}"
      }
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
  "typeVersion": 2
}
```

## Рекомендации по оптимизации SearchAgent

### 1. Оптимизация поисковых запросов

- **Используйте конкретные термины** вместо общих фраз
- **Применяйте операторы поиска** (кавычки для точного совпадения, минус для исключения и т.д.)
- **Указывайте временной диапазон** для поиска актуальной информации
- **Ограничивайте результаты надежными доменами** при необходимости

### 2. Обработка результатов поиска

- **Приоритизируйте авторитетные источники**
- **Проверяйте информацию** через несколько источников
- **Обращайте внимание на даты публикации**
- **Разделяйте факты и мнения** при анализе контента

### 3. Структурирование информации

- **Группируйте информацию по темам**
- **Выделяйте ключевые факты** в начале ответа
- **Используйте маркированные списки** для удобства чтения
- **Организуйте информацию** от общего к частному

### 4. Работа с векторной памятью

- **Сохраняйте только ценную информацию** с долгосрочной полезностью
- **Категоризируйте сохраняемую информацию** для удобного поиска
- **Добавляйте метаданные** о датировке и надежности источников
- **Регулярно обновляйте устаревшую информацию** в базе знаний

## Примеры использования

### Пример 1: Поиск актуальной информации о событии

**Запрос пользователя**: "Расскажи о последних событиях на WWDC 2024"

**Действия SearchAgent**:
1. Формирует поисковый запрос: "WWDC 2024 announcements latest news"
2. Анализирует результаты поиска
3. Извлекает ключевую информацию о новых продуктах и функциях
4. Структурирует информацию по категориям (iOS, macOS, watchOS и т.д.)
5. Проверяет информацию через несколько источников
6. Формирует детальный ответ с указанием источников

### Пример 2: Исследование научной темы

**Запрос пользователя**: "Какие последние достижения в квантовых вычислениях?"

**Действия SearchAgent**:
1. Формирует поисковый запрос: "quantum computing breakthroughs latest research 2024"
2. Анализирует научные и технические источники
3. Извлекает информацию о ключевых исследованиях и открытиях
4. Сравнивает информацию из разных источников
5. Структурирует ответ по направлениям исследований
6. Сохраняет важную информацию в базу знаний для будущих запросов

## Обработка ошибок и ограничений

### 1. Недостаточно информации в результатах поиска

- Попробуйте переформулировать запрос
- Расширьте область поиска
- Используйте альтернативные источники

### 2. Противоречивая информация

- Укажите различные точки зрения
- Обратите внимание на надежность источников
- Предложите пользователю уточнить запрос

### 3. Устаревшая информация

- Укажите дату публикации источника
- Отметьте, что информация может быть устаревшей
- Предложите пользователю обратиться к более актуальным источникам

## Расширение возможностей SearchAgent

### 1. Интеграция с дополнительными поисковыми API

- Google Custom Search API
- Bing Search API
- DuckDuckGo API
- Специализированные поисковые API (научные статьи, новости и т.д.)

### 2. Улучшение анализа и обработки результатов

- Автоматическое определение противоречий в разных источниках
- Оценка авторитетности источников
- Извлечение структурированных данных (таблицы, графики)

### 3. Персонализация поиска

- Учет предыдущих запросов и интересов пользователя
- Адаптация уровня детализации ответа под предпочтения пользователя
- Сохранение предпочтительных источников и тем