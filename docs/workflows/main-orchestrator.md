# Центральный оркестратор (Main Orchestrator)

## Назначение

Центральный оркестратор является ядром всей системы и выполняет следующие основные функции:
1. Принимает входящие сообщения из Telegram
2. Классифицирует тип сообщения (текст/голос/медиа)
3. Анализирует содержимое запроса
4. Планирует последовательность действий для выполнения запроса
5. Координирует работу специализированных агентов
6. Возвращает ответ пользователю

## Структура рабочего потока

Ниже представлена структура рабочего потока центрального оркестратора в n8n:

```
Telegram Trigger → Message Classification → Voice Processing → Main Agent → Specialized Agents → Response
                                                  ↓                 ↑
                                           Media Processing         ↑
                                                                    ↑
                                      ←─────────────────────────────┘
                                 RAG Memory System (Zep + Pinecone)
```

## Компоненты

### 1. Telegram Trigger Node

**Тип**: `n8n-nodes-base.telegramTrigger`

**Параметры**:
```json
{
  "parameters": {
    "updates": ["message"],
    "additionalFields": {}
  }
}
```

**Назначение**: Слушает новые сообщения в Telegram и запускает рабочий поток при их получении.

### 2. Message Classification Node

**Тип**: `n8n-nodes-base.switch`

**Параметры**:
```json
{
  "parameters": {
    "rules": {
      "values": [
        {
          "conditions": {
            "conditions": [
              {
                "leftValue": "={{ $json.message.voice.file_id }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "outputKey": "Voice"
        },
        {
          "conditions": {
            "conditions": [
              {
                "leftValue": "={{ $json.message.text }}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "outputKey": "Text"
        }
      ]
    }
  }
}
```

**Назначение**: Классифицирует входящее сообщение по типу (текст, голос, медиа) и направляет в соответствующую ветку обработки.

### 3. Voice Processing Nodes

#### 3.1. Download File Node

**Тип**: `n8n-nodes-base.telegram`

**Параметры**:
```json
{
  "parameters": {
    "resource": "file",
    "fileId": "={{ $json.message.voice.file_id }}"
  }
}
```

**Назначение**: Загружает голосовое сообщение для последующей транскрипции.

#### 3.2. Transcribe Node

**Тип**: `@n8n/n8n-nodes-langchain.openAi`

**Параметры**:
```json
{
  "parameters": {
    "resource": "audio",
    "operation": "transcribe",
    "options": {}
  }
}
```

**Назначение**: Преобразует голосовое сообщение в текст с помощью OpenAI Whisper API.

### 4. Main Agent Node

**Тип**: `@n8n/n8n-nodes-langchain.agent`

**Параметры**:
```json
{
  "parameters": {
    "promptType": "define",
    "text": "={{ $json.text }}",
    "options": {
      "systemMessage": "# Overview\nТы интеллектуальный персональный ассистент. Твоя задача - перенаправлять запросы пользователя на нужные инструменты. Отвечай ТОЛЬКО НА РУССКОМ ЯЗЫКЕ.\n\n## Tools\n- emailAgent: Используй для действий с электронной почтой\n- calendarAgent: Используй для работы с календарем\n- contactAgent: Используй для получения, обновления или добавления контактов\n- telegramAgent: Используй для отправки сообщений в Telegram\n- twitterAgent: Используй для публикации твитов в Twitter\n- facebookAgent: Используй для публикации постов в Facebook\n- searchAgent: Используй для поиска информации в интернете\n- researchAgent: Используй для глубокого изучения тем\n- mediaAgent: Используй для создания медиа-контента\n- userProfileAgent: Используй для управления профилем пользователя\n\n## Правила работы\n1. Проанализируй запрос пользователя\n2. Определи, какой инструмент лучше всего подходит для выполнения запроса\n3. Если запрос сложный, раздели его на подзадачи\n4. Определи последовательность выполнения подзадач\n5. Используй нужные инструменты для выполнения задач\n6. Если требуется подтверждение от пользователя, запроси его\n7. Всегда пиши на русском языке\n\n## Текущая дата/время: {{ $now }}"
    }
  }
}
```

**Назначение**: Основной LLM-агент, который анализирует запрос пользователя, планирует действия и координирует работу специализированных агентов.

### 5. Language Model Integration

**Тип**: `@n8n/n8n-nodes-langchain.lmChatOpenRouter`

**Параметры**:
```json
{
  "parameters": {
    "model": "openai/gpt-4o",
    "options": {}
  }
}
```

**Назначение**: Предоставляет доступ к языковой модели gpt-4o через OpenRouter для работы Main Agent.

### 6. Memory Integration

**Тип**: `@n8n/n8n-nodes-langchain.memoryZep`

**Параметры**:
```json
{
  "parameters": {
    "sessionIdType": "customKey",
    "sessionKey": "={{ $('Telegram Trigger').item.json.message.chat.id }}"
  }
}
```

**Назначение**: Интегрирует систему памяти Zep для хранения истории диалогов.

### 7. Vector Database Integration

**Тип**: `@n8n/n8n-nodes-langchain.vectorStorePinecone`

**Параметры**:
```json
{
  "parameters": {
    "mode": "retrieve-as-tool",
    "toolName": "Knowledge",
    "toolDescription": "Use this tool when asking questions from our own knowledge base.",
    "pineconeIndex": "n8ntest"
  }
}
```

**Назначение**: Интегрирует векторную базу данных Pinecone для хранения и извлечения информации.

### 8. Response Node

**Тип**: `n8n-nodes-base.telegram`

**Параметры**:
```json
{
  "parameters": {
    "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
    "text": "={{ $json.output }}",
    "additionalFields": {
      "appendAttribution": false
    }
  }
}
```

**Назначение**: Отправляет ответ пользователю в Telegram.

## Системный промпт (полная версия)

Ниже представлена полная версия рекомендуемого системного промпта для центрального оркестратора:

```
# Универсальный персональный ассистент

Ты интеллектуальный ассистент, который анализирует запросы, планирует их выполнение и координирует доступные инструменты для решения задач пользователя. Отвечай ТОЛЬКО НА РУССКОМ ЯЗЫКЕ.

## Планирование задач
1. Проанализируй запрос пользователя
2. Разбей сложные запросы на подзадачи
3. Определи приоритет для каждой подзадачи
4. Сформируй план действий
5. При необходимости, запроси подтверждение от пользователя

## Инструменты и возможности
- Используй searchAgent для поиска информации в интернете
- Используй Knowledge для обращения к накопленным знаниям
- Используй emailAgent для работы с почтой
- Используй calendarAgent для работы с календарем
- Используй contactAgent для работы с контактами
- Используй telegramAgent для отправки сообщений в Telegram
- Используй twitterAgent для публикации в Twitter
- Используй facebookAgent для публикации в Facebook
- Используй mediaAgent для генерации изображений и видео
- Используй contentAgent для создания текстового контента
- Используй researchAgent для глубокого изучения тем
- Используй userProfileAgent для работы с профилем пользователя

## Правила для Telegram
Если пользователь хочет отправить сообщение в Telegram, используй telegramAgent с параметром query в формате: "Send [имя контакта]: [текст сообщения]"

## Правила для Twitter
Если пользователь хочет опубликовать твит, используй twitterAgent, указывая готовый текст твита или необходимую тему

## Правила для Facebook
Если пользователь хочет опубликовать пост на Facebook, используй facebookAgent, указывая готовый текст поста или необходимую тему

## Правила для электронной почты
1. Для отправки письма:
   - Сначала используй contactAgent для получения адреса электронной почты
   - Затем используй emailAgent для составления и отправки письма

## Работа с информацией
1. Для поиска информации используй searchAgent
2. Для сохранения важной информации используй Knowledge
3. Для глубокого изучения тем используй researchAgent

## Работа с медиа-контентом
1. Для создания изображений используй mediaAgent
2. Для создания видео используй mediaAgent
3. Для публикации медиа-контента используй соответствующие агенты социальных сетей

## Общение с пользователем
- Всегда отвечай на русском языке
- Запрашивай дополнительную информацию, если необходимо
- Представляй результаты в структурированном виде
- Сообщай о прогрессе выполнения сложных задач
- Проси подтверждения перед выполнением важных действий

## Текущая дата/время: {{ $now }}
```

## Подключение специализированных агентов

Для подключения специализированных агентов к центральному оркестратору используются узлы n8n типа `@n8n/n8n-nodes-langchain.toolWorkflow`. Ниже представлен пример подключения Email Agent:

```json
{
  "parameters": {
    "name": "emailAgent",
    "description": "Используйте этот инструмент для любых действий с электронной почтой.",
    "workflowId": {
      "value": "AXXrxIPAjgS16wtZ",
      "mode": "list",
      "cachedResultName": "EMAIL_Agent"
    },
    "workflowInputs": {
      "mappingMode": "defineBelow",
      "value": {},
      "matchingColumns": [],
      "schema": []
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
  "typeVersion": 2,
  "position": [
    460,
    780
  ]
}
```

## Оптимизация производительности

Для оптимизации производительности центрального оркестратора рекомендуется:

1. **Оптимизировать системный промпт**
   - Избегать избыточных описаний
   - Использовать короткие и четкие инструкции
   - Приводить примеры для сложных случаев

2. **Оптимизировать использование памяти**
   - Ограничивать размер истории диалогов
   - Периодически обобщать и архивировать старые диалоги
   - Использовать метаданные для улучшения поиска

3. **Реализовать параллельное выполнение**
   - Независимые задачи выполнять параллельно
   - Использовать асинхронное взаимодействие с агентами

4. **Использовать кэширование**
   - Кэшировать часто запрашиваемую информацию
   - Кэшировать результаты взаимодействия с внешними API

## Обработка ошибок

Для надежной обработки ошибок рекомендуется:

1. **Реализовать механизм повторных попыток**
   - Для транзиентных ошибок выполнять повторные попытки
   - Использовать экспоненциальную задержку между попытками

2. **Использовать альтернативные пути**
   - Для критических операций иметь альтернативные пути выполнения
   - При недоступности одного агента использовать другие

3. **Информировать пользователя о проблемах**
   - Сообщать о возникших проблемах
   - Предлагать альтернативные решения

4. **Логировать ошибки**
   - Подробно логировать все ошибки
   - Анализировать логи для выявления системных проблем