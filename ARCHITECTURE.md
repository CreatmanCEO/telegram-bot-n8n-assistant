# Архитектура телеграм-бота на n8n

## Общая архитектурная схема

```
┌───────────────────────┐     ┌───────────────────────┐     ┌─────────────────────────────┐
│  Входящие сообщения   │     │    Центральный        │     │   Модули обработки и        │
│  и запросы            │────▶│    оркестратор       │────▶│   интеграции                │
└───────────────────────┘     └───────────────────────┘     └─────────────────────────────┘
          ▲                              │                               │
          │                              ▼                               ▼
┌───────────────────────┐     ┌───────────────────────┐     ┌─────────────────────────────┐
│  Векторная память     │◀───▶│    Система            │◀───▶│   Внешние API               │
│  (RAG)                │     │    планирования       │     │   и сервисы                 │
└───────────────────────┘     └───────────────────────┘     └─────────────────────────────┘
```

## Компоненты системы

### 1. Обработка входящих сообщений
- **Telegram Trigger** - принимает сообщения из Telegram
- **Message Classifier** - определяет тип входящего сообщения (текст/голос/медиа)
- **Voice Transcriber** - транскрибирует голосовые сообщения в текст
- **Media Extractor** - извлекает информацию из медиафайлов

### 2. Центральный оркестратор
- **Main Agent** - основной LLM-агент для обработки запросов
- **Task Parser** - выделяет задачи из запроса пользователя
- **Task Prioritizer** - определяет приоритет задач
- **Execution Planner** - создает план выполнения задач
- **Confirmation Manager** - запрашивает подтверждение у пользователя

### 3. Специализированные агенты
- **SearchAgent** - поиск и анализ информации в интернете
- **EmailAgent** - управление электронной почтой
- **CalendarAgent** - управление календарем и событиями
- **ContentAgent** - создание текстового контента
- **MediaAgent** - генерация медиа-контента через Fal.AI
- **SocialAgent** - публикация в социальных сетях
- **ResearchAgent** - глубокий анализ тем
- **UserProfileAgent** - управление профилем пользователя

### 4. Система памяти
- **RAG Memory Manager** - управление векторной памятью
- **Knowledge Indexer** - индексирование новой информации
- **Context Retriever** - извлечение релевантного контекста
- **User Preference Store** - хранение предпочтений пользователя
- **Execution Logger** - логирование выполненных действий

### 5. Внешние интеграции
- **OpenRouter Connector** - доступ к различным LLM
- **Fal.AI Connector** - генерация медиа-контента
- **Google Services** - интеграция с Gmail, Google Calendar, Drive
- **Social Media APIs** - публикация в соцсетях
- **Web Search APIs** - поиск информации в интернете

## Последовательность обработки запросов

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Получение  │     │  Понимание  │     │ Планирование│     │  Выполнение │
│  запроса    │────▶│  запроса    │────▶│  действий   │────▶│  действий   │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                           │                   │                   │
                           ▼                   ▼                   ▼
                    ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
                    │  Векторная  │     │ Запрос под- │     │  Возврат    │
                    │  память     │     │ тверждения  │     │  результата │
                    └─────────────┘     └─────────────┘     └─────────────┘
```

## Система RAG-памяти и знаний

### Структура векторной памяти
- **Личная информация о пользователе**
  - Предпочтения и интересы
  - История взаимодействий
  - Ключевые контакты и отношения

- **Тематические знания**
  - Каталогизированные по темам
  - С метаданными о релевантности и актуальности
  - С источниками информации

- **Операционные данные**
  - История выполненных задач
  - Логи взаимодействия с сервисами
  - Шаблоны и примеры успешных выполнений

### Процесс управления знаниями
1. **Сбор информации**
   - Из запросов пользователя
   - Из результатов поиска
   - Из внешних источников

2. **Обработка информации**
   - Фильтрация неважного
   - Структурирование
   - Обобщение и связывание

3. **Использование информации**
   - Извлечение релевантной информации по запросу
   - Обогащение контекста обработки запросов
   - Персонализация ответов

## Процесс создания и публикации контента

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Запрос на  │     │  Сбор       │     │ Генерация   │     │ Проверка    │
│  контент    │────▶│  информации │────▶│ контента    │────▶│ пользоват.  │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                                                                   │
                                                                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  Сохранение │     │  Публикация │     │ Оптимизация │     │ Редактиров. │
│  контента   │◀────│  контента   │◀────│ для канала  │◀────│ по отзыву   │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

## Модули и рабочие потоки n8n

### Основные рабочие потоки (workflows)
1. **Main Orchestrator** - центральный рабочий поток для обработки запросов
2. **Message Processing** - обработка и классификация сообщений
3. **Task Execution** - выполнение задач и интеграций
4. **Memory Management** - управление векторной памятью
5. **Content Creation** - создание контента
6. **Media Generation** - генерация медиа через Fal.AI
7. **Social Publishing** - публикация в социальных сетях
8. **Research and Analysis** - исследование тем
9. **User Profile Management** - управление профилем пользователя
10. **Notification and Reporting** - уведомления и отчеты

### Дополнительные служебные потоки
1. **Error Handling** - обработка ошибок и исключений
2. **Monitoring** - мониторинг состояния системы
3. **Backup** - резервное копирование данных
4. **System Maintenance** - обслуживание системы

## Интеграция с моделями ИИ

### OpenRouter интеграции
- **gpt-4o** - основная модель для центрального агента
- **claude-3-opus** - для генерации сложного контента
- **gemini-pro** - для работы с мультимодальными данными
- **llama-3** - для быстрых и менее сложных задач

### Fal.AI интеграции
- **Stable Diffusion XL** - генерация изображений
- **DALLE-3** - творческие изображения
- **Sora-подобные модели** - генерация видео
- **Video editing models** - редактирование видео